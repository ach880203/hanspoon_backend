<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>한스푼 - 레시피 등록</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --primary-color: #ff6b6b; --secondary-color: #4ecdc4; }
    body { background-color: #fcfcfc; font-family: 'Pretendard', sans-serif; color: #333; }
    .recipe-container { max-width: 1100px; margin: 50px auto; }
    .card { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 30px; }
    .card-header { background: #fff; border-bottom: 2px solid #f8f9fa; padding: 25px; font-weight: 700; font-size: 1.2rem; border-radius: 20px 20px 0 0 !important; }
    .group-container { background-color: #fff; border: 2px solid #f1f3f5; border-radius: 15px; padding: 20px; margin-bottom: 20px; position: relative; }
    .btn-primary { background-color: var(--primary-color); border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; }
    .btn-primary:hover { background-color: #fa5252; }
    .remove-btn { color: #ff6b6b; cursor: pointer; transition: 0.2s; }
    .add-btn-circle { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #dee2e6; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #adb5bd; transition: 0.3s; margin: 10px auto; }
    .flavor-label { font-size: 0.9rem; font-weight: bold; color: #666; display: inline-block; width: 60px; }
    .form-label { font-weight: 600; color: #495057; }
    .step-img-preview { width: 100%; height: 120px; background: #eee; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #999; margin-top: 5px; overflow: hidden; }
    .step-img-preview img { width: 100%; height: 100%; object-fit: cover; }
  </style>
</head>
<body>

<div class="recipe-container">
  <!-- 중요: enctype="multipart/form-data"가 없으면 파일은 절대 전송되지 않습니다. -->
  <form th:action="@{/recipe/new}" th:object="${recipeFormDto}" method="post" id="recipeForm" enctype="multipart/form-data">

    <div class="d-flex justify-content-between align-items-center mb-5">
      <h1 class="fw-bold"><span style="color:var(--primary-color)">한</span>스푼 레시피</h1>
      <div>
        <button type="submit" class="btn btn-primary shadow-sm">레시피 저장하기</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><i class="fa-solid fa-circle-info me-2 text-warning"></i>기본 정보 & 맛 지표</div>
      <div class="card-body p-4">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">레시피 대표 사진</label>
            <!-- 컨트롤러에서 @RequestParam("recipeMainImg") MultipartFile 로 받거나 DTO에 해당 이름의 MultipartFile 필드가 있어야 함 -->
            <input type="file" name="recipeMainImg" class="form-control mb-3" accept="image/*">

            <label class="form-label">레시피 제목</label>
            <input type="text" th:field="*{title}" class="form-control form-control-lg" placeholder="레시피 제목" required>
          </div>

          <div class="col-md-6 mb-3 border-start ps-4">
            <label class="form-label text-primary mb-3">전체 맛 지표 설정 (0~5)</label>
            <div class="mb-3 d-flex align-items-center">
              <span class="flavor-label">매운맛</span>
              <input type="range" class="form-range" min="0" max="5" th:field="*{spiciness}">
            </div>
            <div class="mb-3 d-flex align-items-center">
              <span class="flavor-label">단맛</span>
              <input type="range" class="form-range" min="0" max="5" th:field="*{sweetness}">
            </div>
            <div class="mb-3 d-flex align-items-center">
              <span class="flavor-label">짠맛</span>
              <input type="range" class="form-range" min="0" max="5" th:field="*{saltiness}">
            </div>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-4">
            <label class="form-label">카테고리</label>
            <select th:field="*{category}" class="form-select">
              <option value="KOREAN">한식</option>
              <option value="BAKERY">베이커리</option>
              <option value="DESSERT">디저트</option>
              <option value="ETC">기타</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">기준 인분</label>
            <input type="number" th:field="*{baseServings}" class="form-control" min="1" required>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fa-solid fa-basket-shopping me-2 text-success"></i>재료 정보</span>
        <button type="button" class="btn btn-sm btn-outline-success" onclick="addIngredientGroup()">그룹 추가</button>
      </div>
      <div class="card-body p-4" id="ingredientGroupWrapper"></div>
    </div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fa-solid fa-fire-burner me-2 text-danger"></i>조리 순서</span>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="addInstructionGroup()">단계 추가</button>
      </div>
      <div class="card-body p-4" id="instructionGroupWrapper"></div>
    </div>
    <div class="card">
      <div class="card-header">함께 곁들이면 좋은 서브 레시피</div>
      <div class="card-body p-4">
        <select th:field="*{subrecipe}" class="form-select" multiple size="5">
          <option th:each="sub : ${subRecipeList}" th:value="${sub.id}" th:text="${sub.title}"></option>
        </select>
        <p class="text-muted mt-2 small"><i class="fa-solid fa-circle-exclamation me-1"></i>컨트롤 키를 누른 채 클릭하면 여러 개를 선택할 수 있습니다.</p>
      </div>
    </div>
  </form>
</div>

<!-- [템플릿] 재료 그룹 -->
<script id="ingGroupTemplate" type="text/template">
  <div class="group-container" id="ingGroup_{gIdx}">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <input type="text" name="ingredientGroup[{gIdx}].name" class="form-control fw-bold w-50" placeholder="그룹명 (예: 메인 재료)">
      <i class="fa-solid fa-trash-can remove-btn" onclick="removeElement('ingGroup_{gIdx}')"></i>
    </div>
    <div id="ingRowWrapper_{gIdx}"></div>
    <div class="add-btn-circle" onclick="addIngredientRow({gIdx})"><i class="fa-solid fa-plus"></i></div>
  </div>
</script>

<!-- [템플릿] 재료 줄 -->
<script id="ingRowTemplate" type="text/template">
  <div class="row g-2 mb-2 align-items-center" id="ingRow_{gIdx}_{rIdx}">
    <div class="col-md-3"><input type="text" name="ingredientGroup[{gIdx}].ingredients[{rIdx}].name" class="form-control" placeholder="재료명"></div>
    <div class="col-md-2"><input type="number" name="ingredientGroup[{gIdx}].ingredients[{rIdx}].baseAmount" class="form-control" placeholder="양"></div>
    <div class="col-md-2"><input type="text" name="ingredientGroup[{gIdx}].ingredients[{rIdx}].unit" class="form-control" placeholder="단위"></div>
    <div class="col-md-3">
      <select name="ingredientGroup[{gIdx}].ingredients[{rIdx}].tasteType" class="form-select">
        <option value="NONE">맛 영향 없음</option>
        <option value="SWEET">단맛</option>
        <option value="SALT">짠맛</option>
        <option value="SPICY">매운맛</option>
      </select>
    </div>
    <div class="col-md-1 text-center">
      <div class="form-check d-inline-block">
        <input class="form-check-input" type="checkbox"
               name="ingredientGroup[{gIdx}].ingredients[{rIdx}].main"
               value="true"
               id="mainCheck_{gIdx}_{rIdx}">
        <label class="form-check-label" for="mainCheck_{gIdx}_{rIdx}">메인</label>
      </div>
      </div>
    <div class="col-md-1 text-end"><i class="fa-solid fa-xmark remove-btn" onclick="removeElement('ingRow_{gIdx}_{rIdx}')"></i></div>
  </div>
</script>

<!-- [템플릿] 조리 그룹 -->
<script id="instGroupTemplate" type="text/template">
  <div class="group-container" id="instGroup_{gIdx}">
    <input type="hidden" name="instructionGroup[{gIdx}].sortOrder" value="{gIdx}">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <input type="text" name="instructionGroup[{gIdx}].title" class="form-control fw-bold w-50" placeholder="단계 제목">
      <i class="fa-solid fa-trash-can remove-btn" onclick="removeElement('instGroup_{gIdx}')"></i>
    </div>
    <div id="instRowWrapper_{gIdx}"></div>
    <div class="add-btn-circle" onclick="addInstructionRow({gIdx})"><i class="fa-solid fa-plus"></i></div>
  </div>
</script>

<!-- [템플릿] 조리 단계 (중요: 사진 name 수정) -->
<script id="instRowTemplate" type="text/template">
  <div class="p-3 border rounded mb-3 bg-light" id="instRow_{gIdx}_{rIdx}">
    <input type="hidden" name="instructionGroup[{gIdx}].instructions[{rIdx}].stepOrder" value="{stepNum}">
    <div class="d-flex justify-content-between mb-3">
      <span class="badge bg-secondary">조리 단계 {stepNum}</span>
      <div class="mt-2" id="stepTags_{gIdx}_{rIdx}">
        <div class="tag-list mt-2" id="tagList_{gIdx}_{rIdx}"></div>
      </div>
      <i class="fa-solid fa-xmark remove-btn" onclick="removeElement('instRow_{gIdx}_{rIdx}')"></i>
    </div>
    <div class="row">
      <div class="col-md-8">
        <textarea name="instructionGroup[{gIdx}].instructions[{rIdx}].content" class="form-control" rows="4" placeholder="@설탕 을(를) 넣으세요"></textarea>
      </div>
      <div class="col-md-4">
        <label class="form-label small">과정 사진</label>
        <!-- name에 인덱스를 포함시켜 스프링 리스트 바인딩 대응 -->
        <input type="file" name="instructionGroup[{gIdx}].instructions[{rIdx}].stepImg" class="form-control form-control-sm" accept="image/*" onchange="previewImg(this)">
        <div class="step-img-preview">미리보기</div>
      </div>
    </div>
  </div>
</script>

<script>
  let ingGroupCount = 0;
  let instGroupCount = 0;

  window.onload = function() {
    addIngredientGroup();
    addInstructionGroup();
  };

    function addIngredientGroup() {
    let template = document.getElementById('ingGroupTemplate').innerHTML;
    template = template.replace(/{gIdx}/g, ingGroupCount);
    document.getElementById('ingredientGroupWrapper').insertAdjacentHTML('beforeend', template);
    addIngredientRow(ingGroupCount);
    ingGroupCount++;
  }

  function addIngredientRow(gIdx) {
    const wrapper = document.getElementById(`ingRowWrapper_${gIdx}`);
    const rIdx = wrapper.children.length;
    let template = document.getElementById('ingRowTemplate').innerHTML;
    template = template.replace(/{gIdx}/g, gIdx).replace(/{rIdx}/g, rIdx);
    wrapper.insertAdjacentHTML('beforeend', template);
  }

  function addInstructionGroup() {
    let template = document.getElementById('instGroupTemplate').innerHTML;
    template = template.replace(/{gIdx}/g, instGroupCount);
    document.getElementById('instructionGroupWrapper').insertAdjacentHTML('beforeend', template);
    addInstructionRow(instGroupCount);
    instGroupCount++;
  }

  function addInstructionRow(gIdx) {
    const wrapper = document.getElementById(`instRowWrapper_${gIdx}`);
    const rIdx = wrapper.children.length;
    let template = document.getElementById('instRowTemplate').innerHTML;
    template = template.replace(/{gIdx}/g, gIdx).replace(/{rIdx}/g, rIdx).replace(/{stepNum}/g, rIdx + 1);
    wrapper.insertAdjacentHTML('beforeend', template);
  }

  function removeElement(id) {
    const el = document.getElementById(id);
    if(el) el.remove();
  }

  // 간단한 이미지 미리보기 함수
  function previewImg(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      const previewDiv = input.nextElementSibling;
      reader.onload = function(e) {
        previewDiv.innerHTML = `<img src="${e.target.result}">`;
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>

</body>
</html>
