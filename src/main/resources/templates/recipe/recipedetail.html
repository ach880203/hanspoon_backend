<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${recipe.title}">ë ˆì‹œí”¼ ìƒì„¸ ì •ë³´</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .recipe-header { padding: 40px 0; background: white; border-bottom: 1px solid #eee; margin-bottom: 30px; }

        /* [í•µì‹¬] ì¬ë£Œ í•­ëª© ê³ ì • (Sticky) ìŠ¤íƒ€ì¼ */
        .sticky-sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .step-card { border: none; border-radius: 12px; transition: transform 0.2s; }
        .step-card:hover { transform: translateY(-5px); }
        .step-number {
            width: 30px; height: 30px; background: #ff6b6b; color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin-bottom: 10px;
        }

        .ing-input { width: 70px; text-align: right; border: 1px solid #ddd; border-radius: 4px; }
        .unit-text { color: #666; font-size: 0.9rem; margin-left: 3px; }
        .ing-group-title { font-weight: bold; color: #555; margin-top: 15px; border-left: 4px solid #ff6b6b; padding-left: 10px; }
    </style>
</head>
<body>

<header class="recipe-header shadow-sm">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6 mb-4 mb-md-0">
                <div class="recipe-img-container shadow rounded-4 overflow-hidden">
                    <img th:src="${recipe.recipeImg != null ? '/images/recipe/' + recipe.recipeImg : '/images/default-recipe.jpg'}"
                         alt="ë ˆì‹œí”¼ ì´ë¯¸ì§€" class="img-fluid w-100">
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 shadow-sm p-4 bg-white h-100">
                    <h1 class="display-6 fw-bold mb-3" th:text="${recipe.title}">ë ˆì‹œí”¼ ì œëª©</h1>
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <span class="badge bg-primary px-3 py-2" th:text="${recipe.category}">í•œì‹</span>
                        <div>
                            <input type="number" id="servingsInput" class="form-control d-inline-block w-auto"
                                   th:value="${recipe.baseServings}" step="0.5" min="0.5">
                            <span class="fw-bold">ì¸ë¶„</span>
                        </div>
                        <div class="col-md-6 mb-3 border-start ps-4">
                            <label class="form-label text-primary fw-bold mb-3">ğŸ˜‹ ë‚´ ì…ë§›ì— ë§ê²Œ ì¡°ì ˆí•´ë³´ê¸°</label>

                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="flavor-label">ë§¤ìš´ë§›</span>
                                    <span class="text-muted small">ê¸°ë³¸: <span th:text="${recipe.spiciness}">3</span></span>
                                </div>
                                <input type="range" class="form-range flavor-slider" min="0" max="5"
                                       th:value="${recipe.spiciness}" id="spicySlider">
                                <div class="text-end">
                                    <span class="badge rounded-pill bg-danger" id="spicyValue">í˜„ì¬: [[${recipe.spiciness}]]</span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="flavor-label">ë‹¨ë§›</span>
                                    <span class="text-muted small">ê¸°ë³¸: <span th:text="${recipe.sweetness}">2</span></span>
                                </div>
                                <input type="range" class="form-range flavor-slider" min="0" max="5"
                                       th:value="${recipe.sweetness}" id="sweetSlider">
                                <div class="text-end">
                                    <span class="badge rounded-pill bg-warning text-dark" id="sweetValue">í˜„ì¬: [[${recipe.sweetness}]]</span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="flavor-label">ì§ ë§›</span>
                                    <span class="text-muted small">ê¸°ë³¸: <span th:text="${recipe.saltiness}">2</span></span>
                                </div>
                                <input type="range" class="form-range flavor-slider" min="0" max="5"
                                       th:value="${recipe.saltiness}" id="saltSlider">
                                <div class="text-end">
                                    <span class="badge rounded-pill bg-primary" id="saltValue">í˜„ì¬: [[${recipe.saltiness}]]</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h4 class="mb-3">ğŸ›’ í•„ìš”í•œ ì¬ë£Œ</h4>
                    <div class="ingredient-scroll-area" style="max-height: 250px; overflow-y: auto;">
                        <div th:each="group : ${recipe.ingredientGroup}">
                            <div class="ing-group-title mb-2" th:text="${group.name}">ë©”ì¸ ì¬ë£Œ</div>
                            <div th:each="ing : ${group.ingredients}" class="d-flex justify-content-between align-items-center mb-2 pe-2">
                                <span th:text="${ing.name}" class="ing-name">ë¼ì§€ê³ ê¸° ì•ë‹¤ë¦¬ì‚´</span> <div class="d-flex align-items-center">
                                <input type="number" class="ing-input me-1"
                                       th:value="${ing.baseAmount}"
                                       th:data-base="${ing.baseAmount}">
                                <span class="unit-text" th:text="${ing.unit}">g</span> </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="container pb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h3 class="mb-4 text-center">ğŸ³ ì¡°ë¦¬ ìˆœì„œ</h3>
            <div th:each="group : ${recipe.instructionGroup}" class="mb-5">
                <h5 class="text-secondary mb-3 border-bottom pb-2" th:text="${group.title}">ê·¸ë£¹ëª…</h5>
                <div th:each="inst : ${group.instructions}" class="card step-card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex gap-4 align-items-start">
                            <div class="step-number flex-shrink-0" th:text="${inst.stepOrder}">1</div>
                            <p class="card-text fs-5 mb-0 instruction-content"
                               th:text="${inst.content}"
                                th:attr="data-template=${inst.content}">ì¬ë£Œë¥¼ ë„£ê³  ë³¶ìœ¼ì„¸ìš”.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const baseServings = /*[[${recipe.baseServings}]]*/ 2.0;
    const servingsInput = document.getElementById('servingsInput');
    const ingInputs = document.querySelectorAll('.ing-input');

    // [í•µì‹¬] ì¡°ë¦¬ë²• í…ìŠ¤íŠ¸ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateInstructionText() {
        const contents = document.querySelectorAll('.instruction-content');

        // í™”ë©´ì— í‘œì‹œëœ ì¬ë£Œëª…/ìˆ˜ëŸ‰/ë‹¨ìœ„ë¥¼ ë§µìœ¼ë¡œ ë§Œë“ ë‹¤.
        // ì¡°ë¦¬ë¬¸ ì¹˜í™˜ì€ ì´ ë§µë§Œ ì°¸ì¡°í•˜ë¯€ë¡œ ì¸ë¶„ ë³€ê²½ê³¼ í•­ìƒ ë™ê¸°í™”ëœë‹¤.
        const ingredientState = {};
        document.querySelectorAll('.ing-name').forEach(span => {
            const name = span.textContent.trim();
            const container = span.closest('.d-flex');
            if (!container) return;

            const input = container.querySelector('.ing-input');
            const unit = container.querySelector('.unit-text');
            if (!input || !unit) return;

            ingredientState[name] = {
                amount: input.value,
                unit: unit.textContent
            };
        });

        const escapeRegex = (value) => value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

        contents.forEach(p => {
            let template = p.getAttribute('data-template');
            if (!template) return;

            // {ì¬ë£Œ_amount}ì™€ {ì¬ë£Œ_unit}ì„ ëª¨ë‘ ì°¾ëŠ” ì •ê·œì‹
            const regex = /\{([^}_]+)_(amount|unit)\}/g;

            let newContent = template.replace(regex, (match, ingName, type) => {
                const item = ingredientState[ingName.trim()];
                if (item) {
                    if (type === 'amount') return `<strong class="text-danger">${ingName} ${item.amount}</strong>`;
                    if (type === 'unit') return `<strong class="text-danger">${item.unit}</strong>`;
                }
                return match;
            });

            // @ì¬ë£Œëª… í˜•ì‹ë„ í•¨ê»˜ ì§€ì›í•œë‹¤.
            // ì…ë ¥í¼ ì•ˆë‚´ê°€ @ì¬ë£Œëª… ê¸°ì¤€ì´ë¯€ë¡œ, ê¸°ì¡´ ë ˆì‹œí”¼ í…œí”Œë¦¿ì´ ê·¸ëŒ€ë¡œ ë™ì‘í•´ì•¼ í•œë‹¤.
            Object.keys(ingredientState).forEach(name => {
                const item = ingredientState[name];
                const tokenPattern = new RegExp(`@${escapeRegex(name)}\\b`, 'g');
                newContent = newContent.replace(
                    tokenPattern,
                    `<strong class="text-danger">${name} ${item.amount}${item.unit}</strong>`
                );
            });

            p.innerHTML = newContent;
        });
    }

    // ëª¨ë“  ìˆ˜ì¹˜ë¥¼ ë™ê¸°í™”í•˜ëŠ” í•¨ìˆ˜
    function syncAll(ratio, excludeInput) {
        // 1. ì¬ë£Œ inputë“¤ ê°’ ë³€ê²½
        ingInputs.forEach(input => {
            if (input !== excludeInput) {
                const base = parseFloat(input.dataset.base);
                const result = base * ratio;
                input.value = Number.isInteger(result) ? result : result.toFixed(1);
            }
        });
        // 2. ë°”ë€ ì¬ë£Œê°’ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ì¡°ë¦¬ë²• í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        updateInstructionText();
    }

    // 1. ì¸ë¶„ ë³€ê²½ ì‹œ
    servingsInput.addEventListener('input', function() {
        const ratio = parseFloat(this.value) / baseServings;
        if (ratio > 0) syncAll(ratio, null);
    });

    // 2. ê°œë³„ ì¬ë£Œ ë¬´ê²Œ ë³€ê²½ ì‹œ
    ingInputs.forEach(input => {
        input.addEventListener('input', function() {
            const currentVal = parseFloat(this.value);
            const baseVal = parseFloat(input.dataset.base);

            if (currentVal > 0) {
                const ratio = currentVal / baseVal;
                servingsInput.value = (baseServings * ratio).toFixed(1);
                syncAll(ratio, this);
            }
        });
    });

    // 3. í˜ì´ì§€ ë¡œë“œ ì‹œ ìµœì´ˆ ì‹¤í–‰ (ì¤‘ìš”!)
    window.addEventListener('DOMContentLoaded', () => {
        updateInstructionText();
    });

    // ë§› ì§€í‘œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    const sliders = [
        { id: 'spicySlider', output: 'spicyValue' },
        { id: 'sweetSlider', output: 'sweetValue' },
        { id: 'saltSlider', output: 'saltValue' }
    ];
    sliders.forEach(item => {
        const slider = document.getElementById(item.id);
        const output = document.getElementById(item.output);
        if(slider) {
            slider.addEventListener('input', () => {
                output.textContent = `í˜„ì¬: ${slider.value}`;
            });
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
